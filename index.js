const axios = require('axios');
const express = require('express');
const path = require('path');
const PORT = process.env.PORT || 5000;
let episodes_breaking = [{"episode_id":1,"title":"Pilot","season":"1","air_date":"2008-01-20T00:00:00.000Z","characters":["Walter White","Jesse Pinkman","Skyler White","Hank Schrader","Marie Schrader","Walter White Jr.","Krazy-8","Bogdan Wolynetz"],"episode":1,"series":"Breaking Bad"},{"episode_id":2,"title":"Cat's in the Bag...","season":"1","air_date":"2008-01-27T00:00:00.000Z","characters":["Walter White","Jesse Pinkman","Skyler White","Walter White Jr.","Krazy-8"],"episode":2,"series":"Breaking Bad"},{"episode_id":3,"title":"...And the Bag's in the River","season":"1","air_date":"2008-02-10T00:00:00.000Z","characters":["Walter White","Jesse Pinkman","Skyler White","Hank Schrader","Marie Schrader","Walter White Jr.","Krazy-8","Gretchen Schwartz"],"episode":3,"series":"Breaking Bad"},{"episode_id":4,"title":"Cancer Man","season":"1","air_date":"2008-02-17T00:00:00.000Z","characters":["Walter White","Jesse Pinkman","Skyler White","Hank Schrader","Marie Schrader","Walter White Jr.","Ken Wins"],"episode":4,"series":"Breaking Bad"},{"episode_id":5,"title":"Gray Matter","season":"1","air_date":"2008-02-24T00:00:00.000Z","characters":["Walter White","Jesse Pinkman","Skyler White","Hank Schrader","Marie Schrader","Walter White Jr.","Elliott Schwarts","Gretchen Swartz","Badger"],"episode":5,"series":"Breaking Bad"},{"episode_id":6,"title":"Crazy Handful of Nothin","season":"1","air_date":"2008-03-02T00:00:00.000Z","characters":["Walter White","Jesse Pinkman","Skyler White","Hank Schrader","Marie Schrader","Walter White Jr.","Tuco Salamanca"],"episode":6,"series":"Breaking Bad"},{"episode_id":7,"title":"A No-Rough-Stuff-Type Deal","season":"1","air_date":"2008-03-09T00:00:00.000Z","characters":["Walter White","Jesse Pinkman","Skyler White","Hank Schrader","Marie Schrader","Walter White Jr.","Tuco Salamanca"],"episode":7,"series":"Breaking Bad"},{"episode_id":8,"title":"Seven-Thirty-Seven","season":"2","air_date":"2009-03-08T00:00:00.000Z","characters":["Walter White","Jesse Pinkman","Skyler White","Hank Schrader","Marie Schrader","Walter White Jr.","Tuco Salamanca"],"episode":1,"series":"Breaking Bad"},{"episode_id":9,"title":"Grilled","season":"2","air_date":"2009-03-15T00:00:00.000Z","characters":["Walter White","Jesse Pinkman","Skyler White","Hank Schrader","Marie Schrader","Walter White Jr.","Tuco Salamanca","Hector Salamanca"],"episode":2,"series":"Breaking Bad"},{"episode_id":10,"title":"Bit by a Dead Bee","season":"2","air_date":"2009-03-22T00:00:00.000Z","characters":["Walter White","Jesse Pinkman","Skyler White","Hank Schrader","Marie Schrader","Walter White Jr.","Hector Salamanca"],"episode":3,"series":"Breaking Bad"},{"episode_id":11,"title":"Down","season":"2","air_date":"2009-03-29T00:00:00.000Z","characters":["Walter White","Jesse Pinkman","Skyler White","Walter White Jr."],"episode":4,"series":"Breaking Bad"},{"episode_id":12,"title":"Breakage","season":"2","air_date":"2009-04-05T00:00:00.000Z","characters":["Walter White","Jesse Pinkman","Skyler White","Hank Schrader","Marie Schrader","Walter White Jr.","Jane Margolis","Badger"],"episode":5,"series":"Breaking Bad"},{"episode_id":13,"title":"Peekaboo","season":"2","air_date":"2009-04-12T00:00:00.000Z","characters":["Walter White","Jesse Pinkman","Skyler White","Marie Schrader","Walter White Jr.","Gretchen Schwartz"],"episode":6,"series":"Breaking Bad"},{"episode_id":14,"title":"Negro y Azul","season":"2","air_date":"2009-04-19T00:00:00.000Z","characters":["Walter White","Jesse Pinkman","Skyler White","Hank Schrader","Marie Schrader","Walter White Jr.","Tortuga","Jane Margolis","Ted Beneke"],"episode":7,"series":"Breaking Bad"},{"episode_id":15,"title":"Better Call Saul","season":"2","air_date":"2009-04-26T00:00:00.000Z","characters":["Walter White","Jesse Pinkman","Skyler White","Hank Schrader","Marie Schrader","Saul Goodman","Jane Margolis","Badger"],"episode":8,"series":"Breaking Bad"},{"episode_id":16,"title":"4 Days Out","season":"2","air_date":"2009-05-03T00:00:00.000Z","characters":["Walter White","Jesse Pinkman","Skyler White","Hank Schrader","Marie Schrader","Walter White Jr.","Saul Goodman","Jane Margolis"],"episode":9,"series":"Breaking Bad"},{"episode_id":17,"title":"Over","season":"2","air_date":"2009-05-10T00:00:00.000Z","characters":["Walter White","Jesse Pinkman","Skyler White","Hank Schrader","Marie Schrader","Walter White Jr.","Jane Margolis","Ted Beneke"],"episode":10,"series":"Breaking Bad"},{"episode_id":18,"title":"Mandala","season":"2","air_date":"2009-05-17T00:00:00.000Z","characters":["Walter White","Jesse Pinkman","Skyler White","Saul Goodman","Gustavo Fring","Jane Margolis","Ted Beneke","Donald Margolis","Combo"],"episode":11,"series":"Breaking Bad"},{"episode_id":19,"title":"Phoenix","season":"2","air_date":"2009-05-24T00:00:00.000Z","characters":["Walter White","Jesse Pinkman","Skyler White","Hank Schrader","Marie Schrader","Walter White Jr.","Saul Goodman","Jane Margolis","Ted Beneke","Donald Margolis"],"episode":12,"series":"Breaking Bad"},{"episode_id":20,"title":"ABQ","season":"2","air_date":"2009-05-31T00:00:00.000Z","characters":["Walter White","Jesse Pinkman","Skyler White","Hank Schrader","Marie Schrader","Walter White Jr.","Mike Ehrmantraut","Gustavo Fring","Jane Margolis","Donald Margolis"],"episode":13,"series":"Breaking Bad"},{"episode_id":21,"title":"No Más","season":"3","air_date":"2010-03-21T00:00:00.000Z","characters":["Walter White","Jesse Pinkman","Skyler White","Hank Schrader","Marie Schrader","Walter White Jr.","Gustavo Fring","The cousins"],"episode":1,"series":"Breaking Bad"},{"episode_id":22,"title":"Caballo sin Nombre","season":"3","air_date":"2010-03-28T00:00:00.000Z","characters":["Walter White","Jesse Pinkman","Skyler White","Hank Schrader","Marie Schrader","Walter White Jr.","Gustavo Fring","Saul Goodman","Mike Ehrmantraut","Hector Salamanca"],"episode":2,"series":"Breaking Bad"},{"episode_id":23,"title":"IFT","season":"3","air_date":"2010-04-04T00:00:00.000Z","characters":["Walter White","Jesse Pinkman","Skyler White","Hank Schrader","Walter White Jr.","Gustavo Fring","Saul Goodman","Hector Salamanca","Ted Beneke"],"episode":3,"series":"Breaking Bad"},{"episode_id":24,"title":"Green Light","season":"3","air_date":"2010-04-11T00:00:00.000Z","characters":["Walter White","Jesse Pinkman","Skyler White","Hank Schrader","Marie Schrader","Walter White Jr.","Gustavo Fring","Saul Goodman","Mike Ehrmantraut","Ted Beneke"],"episode":4,"series":"Breaking Bad"},{"episode_id":25,"title":"Más","season":"3","air_date":"2010-04-18T00:00:00.000Z","characters":["Walter White","Jesse Pinkman","Skyler White","Hank Schrader","Marie Schrader","Walter White Jr.","Gustavo Fring","Saul Goodman","Ted Beneke"],"episode":5,"series":"Breaking Bad"},{"episode_id":26,"title":"Sunset","season":"3","air_date":"2010-04-25T00:00:00.000Z","characters":["Walter White","Jesse Pinkman","Skyler White","Hank Schrader","Marie Schrader","Walter White Jr.","Gustavo Fring","Saul Goodman","Gale Boetticher","The cousins"],"episode":6,"series":"Breaking Bad"},{"episode_id":27,"title":"One Minute","season":"3","air_date":"2010-05-02T00:00:00.000Z","characters":["Walter White","Jesse Pinkman","Skyler White","Hank Schrader","Marie Schrader","Saul Goodman","Hector Salamanca","The cousins","Gale Boetticher"],"episode":7,"series":"Breaking Bad"},{"episode_id":28,"title":"I See You","season":"3","air_date":"2010-05-09T00:00:00.000Z","characters":["Walter White","Jesse Pinkman","Skyler White","Hank Schrader","Marie Schrader","Walter White Jr.","Gustavo Fring","Mike Ehrmantraut"],"episode":8,"series":"Breaking Bad"},{"episode_id":29,"title":"Kafkaesque","season":"3","air_date":"2010-05-16T00:00:00.000Z","characters":["Walter White","Jesse Pinkman","Skyler White","Hank Schrader","Marie Schrader","Walter White Jr.","Gustavo Fring","Saul Goodman","Ted Beneke"],"episode":9,"series":"Breaking Bad"},{"episode_id":30,"title":"Fly","season":"3","air_date":"2010-05-23T00:00:00.000Z","characters":["Walter White","Jesse Pinkman","a fly"],"episode":10,"series":"Breaking Bad"},{"episode_id":31,"title":"Abiquiu","season":"3","air_date":"2010-05-30T00:00:00.000Z","characters":["Walter White","Jesse Pinkman","Skyler White","Hank Schrader","Marie Schrader","Walter White Jr.","Gustavo Fring","Saul Goodman","Jane Margolis"],"episode":11,"series":"Breaking Bad"},{"episode_id":32,"title":"Half measures","season":"3","air_date":"2010-06-06T00:00:00.000Z","characters":["Walter White","Jesse Pinkman","Skyler White","Hank Schrader","Marie Schrader","Walter White Jr.","Gustavo Fring","Saul Goodman","Mike Ehrmantraut","Andrea Cantillo","Victor"],"episode":12,"series":"Breaking Bad"},{"episode_id":33,"title":"Full Measure","season":"3","air_date":"2010-06-13T00:00:00.000Z","characters":["Walter White","Jesse Pinkman","Skyler White","Walter White Jr.","Gustavo Fring","Saul Goodman","Mike Ehrmantraut","Gale Boetticher","Victor"],"episode":13,"series":"Breaking Bad"},{"episode_id":34,"title":"Box Cutter","season":"4","air_date":"2011-07-17T00:00:00.000Z","characters":["Walter White","Jesse Pinkman","Skyler White","Hank Schrader","Marie Schrader","Walter White Jr.","Gustavo Fring","Saul Goodman","Mike Ehrmantraut","Gale Boetticher","Victor"],"episode":1,"series":"Breaking Bad"},{"episode_id":35,"title":"Thirty-Eight Snub","season":"4","air_date":"2011-07-24T00:00:00.000Z","characters":["Walter White","Jesse Pinkman","Skyler White","Hank Schrader","Marie Schrader","Walter White Jr.","Gustavo Fring","Saul Goodman","Mike Ehrmantraut","Andrea Cantillo"],"episode":2,"series":"Breaking Bad"},{"episode_id":36,"title":"Open House","season":"4","air_date":"2011-07-31T00:00:00.000Z","characters":["Walter White","Jesse Pinkman","Skyler White","Hank Schrader","Marie Schrader","Saul Goodman","Bogdan Wolynetz"],"episode":3,"series":"Breaking Bad"},{"episode_id":37,"title":"Bullet Points","season":"4","air_date":"2011-08-07T00:00:00.000Z","characters":["Walter White","Jesse Pinkman","Skyler White","Hank Schrader","Marie Schrader","White White Jr.","Gustavo Fring","Saul Goodman","Mike Ehrmantraut","Gale Boetticher"],"episode":4,"series":"Breaking Bad"},{"episode_id":38,"title":"Shotgun","season":"4","air_date":"2011-08-14T00:00:00.000Z","characters":["Walter White","Jesse Pinkman","Skyler White","Hank Schrader","Marie Schrader","Walter White Jr.","Gustavo Fring","Mike Ehrmantraut"],"episode":5,"series":"Breaking Bad"},{"episode_id":39,"title":"Cornered","season":"4","air_date":"2011-08-21T00:00:00.000Z","characters":["Walter White","Jesse Pinkman","Skyler White","Walter White Jr.","Gustavo Fring","Mike Ehrmantraut","Bogdan Wolynetz"],"episode":6,"series":"Breaking Bad"},{"episode_id":40,"title":"Problem Dog","season":"4","air_date":"2011-08-28T00:00:00.000Z","characters":["Walter White","Jesse Pinkman","Skyler White","Hank Schrader","Marie Schrader","Walter White Jr.","Gustavo Fring","Saul Goodman","Mike Ehrmantraut","Gale Boetticher"],"episode":7,"series":"Breaking Bad"},{"episode_id":41,"title":"Hermanos","season":"4","air_date":"2011-09-04T00:00:00.000Z","characters":["Walter White","Jesse Pinkman","Skyler White","Hank Schrader","Marie Schrader","Walter White Jr.","Gustavo Fring","Saul Goodman","Mike Ehrmantraut","Hector Salamanca","Andrea Cantillo"],"episode":8,"series":"Breaking Bad"},{"episode_id":42,"title":"Bug","season":"4","air_date":"2011-09-11T00:00:00.000Z","characters":["Walter White","Jesse Pinkman","Skyler White","Hank Schrader","Marie Schrader","Gustavo Fring","Mike Ehrmantraut","Ted Beneke"],"episode":9,"series":"Breaking Bad"},{"episode_id":43,"title":"Salud","season":"4","air_date":"2011-09-18T00:00:00.000Z","characters":["Walter White","Jesse Pinkman","Skyler White","Walter White Jr.","Gustavo Fring","Saul Goodman","Mike Ehrmantraut","Ted Beneke","Don Eladio"],"episode":10,"series":"Breaking Bad"},{"episode_id":44,"title":"Crawl Space","season":"4","air_date":"2011-09-25T00:00:00.000Z","characters":["Walter White","Jesse Pinkman","Skyler White","Hank Schrader","Marie Schrader","Walter White Jr.","Gustavo Fring","Saul Goodman","Mike Ehrmantraut","Hector Salamanca","Ted Beneke","Andrea Cantillo"],"episode":11,"series":"Breaking Bad"},{"episode_id":45,"title":"End Times","season":"4","air_date":"2011-10-02T00:00:00.000Z","characters":["Walter White","Jesse Pinkman","Skyler White","Hank Schrader","Marie Schrader","Walter White Jr.","Gustavo Fring","Saul Goodman","Andrea Cantillo"],"episode":12,"series":"Breaking Bad"},{"episode_id":46,"title":"Face Off","season":"4","air_date":"2011-10-09T00:00:00.000Z","characters":["Walter White","Jesse Pinkman","Skyler White","Hank Schrader","Marie Schrader","Walter White Jr.","Gustavo Fring","Saul Goodman"],"episode":13,"series":"Breaking Bad"},{"episode_id":47,"title":"Live Free of Die","season":"5","air_date":"2012-07-15T00:00:00.000Z","characters":["Walter White","Jesse Pinkman","Skyler White","Hank Schrader","Walter White Jr.","Saul Goodman","Mike Ehrmantraut","Ted Beneke"],"episode":1,"series":"Breaking Bad"},{"episode_id":48,"title":"Madrigal","season":"5","air_date":"2012-07-22T00:00:00.000Z","characters":["Walter White","Jesse Pinkman","Skyler White","Hank Schrader","Walter White Jr.","Saul Goodman","Mike Ehrmantraut","Lydia Rodarte-Quayle"],"episode":2,"series":"Breaking Bad"},{"episode_id":49,"title":"Hazard Pay","season":"5","air_date":"2012-07-29T00:00:00.000Z","characters":["Walter White","Jesse Pinkman","Skyler White","Marie Schrader","Walter White Jr.","Saul Goodman","Mike Ehrmantraut","Badger","Andrea Cantillo","Todd Alquist"],"episode":3,"series":"Breaking Bad"},{"episode_id":50,"title":"Fifty-One","season":"5","air_date":"2012-08-05T00:00:00.000Z","characters":["Walter White","Jesse Pinkman","Skyler White","Hank Schrader","Marie Schrader","Walter White Jr.","Mike Ehrmantraut","Lydia Rodarte-Quayle"],"episode":4,"series":"Breaking Bad"},{"episode_id":51,"title":"Dead Freight","season":"5","air_date":"2012-08-12T00:00:00.000Z","characters":["Walter White","Jesse Pinkman","Skyler White","Hank Schrader","Marie Schrader","Walter White Jr.","Mike Ehrmantraut","Lydia Rodarte-Quayle","Todd Alquist"],"episode":5,"series":"Breaking Bad"},{"episode_id":52,"title":"Buyout","season":"5","air_date":"2012-08-19T00:00:00.000Z","characters":["Walter White","Jesse Pinkman","Skyler White","Hank Schrader","Marie Schrader","Saul Goodman","Mike Ehrmantraut","Todd Alquist"],"episode":6,"series":"Breaking Bad"},{"episode_id":53,"title":"Say My Name","season":"5","air_date":"2012-08-26T00:00:00.000Z","characters":["Walter White","Jesse Pinkman","Skyler White","Hank Schrader","Saul Goodman","Mike Ehrmantraut","Todd Alquist"],"episode":7,"series":"Breaking Bad"},{"episode_id":54,"title":"Gliding Over All","season":"5","air_date":"2012-09-02T00:00:00.000Z","characters":["Walter White","Jesse Pinkman","Skyler White","Hank Schrader","Marie Schrader","Walter White Jr.","Saul Goodman","Mike Ehrmantraut","Lydia Rodarte-Quayle","Todd Alquist"],"episode":8,"series":"Breaking Bad"},{"episode_id":55,"title":"Blood Money","season":"5","air_date":"2013-08-11T00:00:00.000Z","characters":["Walter White","Jesse Pinkman","Skyler White","Hank Schrader","Marie Schrader","Walter White Jr.","Saul Goodman","Lydia Rodarte-Quayle","Badger","Skinny Pete"],"episode":9,"series":"Breaking Bad"},{"episode_id":56,"title":"Buried","season":"5","air_date":"2013-08-18T00:00:00.000Z","characters":["Walter White","Jesse Pinkman","Skyler White","Hank Schrader","Marie Schrader","Saul Goodman","Lydia Rodarte-Quayle","Todd Alquist","Jack Welker"],"episode":10,"series":"Breaking Bad"},{"episode_id":57,"title":"Confessions","season":"5","air_date":"2013-08-25T00:00:00.000Z","characters":["Walter White","Jesse Pinkman","Skyler White","Hank Schrader","Marie Schrader","Walter White Jr.","Saul Goodman","Todd Alquist","Jack Welker"],"episode":11,"series":"Breaking Bad"},{"episode_id":58,"title":"Rabid Dog","season":"5","air_date":"2013-09-01T00:00:00.000Z","characters":["Walter White","Jesse Pinkman","Skyler White","Hank Schrader","Marie Schrader","Walter White Jr.","Saul Goodman"],"episode":12,"series":"Breaking Bad"},{"episode_id":59,"title":"To'hajilee","season":"5","air_date":"2013-09-08T00:00:00.000Z","characters":["Walter White","Jesse Pinkman","Skyler White","Hank Schrader","Marie Schrader","Walter White Jr.","Saul Goodman","Lydia Rodarte-Quayle","Todd Alquist","Andrea Cantillo","Jack Welker"],"episode":13,"series":"Breaking Bad"},{"episode_id":60,"title":"Ozymandias","season":"5","air_date":"2013-09-15T00:00:00.000Z","characters":["Walter White","Jesse Pinkman","Skyler White","Hank Schrader","Marie Schrader","Walter White Jr.","Todd Alquist","Jack Welker","Steve Gomez"],"episode":14,"series":"Breaking Bad"},{"episode_id":61,"title":"Granite State","season":"5","air_date":"2013-09-22T00:00:00.000Z","characters":["Walter White","Jesse Pinkman","Skyler White","Marie Schrader","Saul Goodman","Lydia Rodarte-Quayle","Todd Alquist","Jack Welker","Andrea Cantillo","Eliott Schwartz","Gretchen Schwartz"],"episode":15,"series":"Breaking Bad"},{"episode_id":62,"title":"Felina","season":"5","air_date":"2013-09-29T00:00:00.000Z","characters":["Walter White","Jesse Pinkman","Skyler White","Marie Schrader","Walter White Jr.","Lydia Rodarte-Quayle","Todd Alquist","Jack Welker","Badger","Skinny Pete","Eliott Schwartz","Gretchen Schwartz"],"episode":16,"series":"Breaking Bad"}];
let episodes_better = [];
//await axios('https://tarea-1-breaking-bad.herokuapp.com/api/episodes?series=Breaking+Bad').then(x => episodes_breaking = x.data);
//await axios('https://tarea-1-breaking-bad.herokuapp.com/api/episodes?series=Better+Call+Saul').then(x => episodes_better = x.data);

express()
  .use(express.static(path.join(__dirname, 'public')))
  .set('views', path.join(__dirname, 'views'))
  .set('view engine', 'ejs')
  .get('/', (req, res) => {
  	let seasons_break = [...new Set(episodes_breaking.map(x => x.season))];
  	//let seasons_better = [...new Set(episodes_breaking.map(x => x.season))]
  	res.render('pages/index', {
  		seasons_break: seasons_break,
  		seasons_better: ["1","2","3"],
  	});
  })
  .get('/episodes', (req, res) => {
  	let show = req.query.show;
  	let season = req.query.season;
  	let index = req.query.index;
  	if (show && season && !index) {
  		let episodes = [];
  		if (show === 'Breaking-Bad') {
  			episodes = episodes_breaking.filter(x => x.season == season);
  		} else {
  			episodes = episodes_better.filter(x => x.season == season);
  		};
  		res.render('pages/episodes', {
	  		show: show.replace("-", " "),
	  		season: season,
	  		episodes: episodes,
	  	});
  	} else if (!show && !season && index) {
  		let breaking = episodes_breaking.filter(x => x.episode_id == index);
  		let better = episodes_better.filter(x => x.episode_id == index);
  		let episode = breaking.concat(better);
  		if (episode.length) {
  			res.render('pages/episode-data', {
  				episode: episode[0]
  			});
  		} else {
  			res.render('pages/404');
  		};
  	} else {
  		res.render('pages/404');
  	};
  })
  .get('/search', async (req, res) => {
  	let name = req.query.name;
  	let results = [];
  	await axios('https://tarea-1-breaking-bad.herokuapp.com/api/api/characters').then(x => results = x.data);
  	if (results.length == 1)
  	res.render('pages/characters', {episode: {characters: []}});
  })
  .get('/characters', (req, res) => {
  	let name = req.query.name;
  	let results = [];
  	await axios('https://tarea-1-breaking-bad.herokuapp.com/api/api/characters').then(x => results = x.data);
  	if (results.length == 1)
  	res.render('pages/characters', {episode: {characters: []}});
  })
  .listen(PORT, () => console.log(`Listening on ${ PORT }`))
